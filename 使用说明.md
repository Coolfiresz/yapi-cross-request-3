# Cross-Request 插件使用说明（Manifest V3 版本）

## 重要提示 ⚠️

### 关于 "Extension context invalidated" 错误

这个错误**不是 bug**，而是 Chrome 扩展的正常行为。

#### 什么时候会出现？

当扩展被重新加载、更新或禁用时，**所有正在运行的页面中的扩展代码都会失效**。

以下操作会导致扩展上下文失效：
- ✅ 在 `chrome://extensions` 页面点击"重新加载"按钮
- ✅ 扩展被自动更新
- ✅ 手动禁用再启用扩展
- ✅ Chrome 浏览器崩溃后恢复

#### 如何解决？

**非常简单：刷新使用插件的页面（YAPI 页面）即可恢复正常！**

快捷键：`F5` 或 `Ctrl + R` (Windows) / `Cmd + R` (Mac)

#### 为什么会这样？

在 Manifest V3 中：
1. 扩展的后台代码运行在 Service Worker 中
2. 当扩展重新加载时，Service Worker 会重启
3. 但页面中的 content script 还在运行，它的上下文已经失效
4. 此时任何调用 `chrome.*` API 的操作都会失败

我们的插件已经添加了完善的检测和提示：
- ✅ 自动检测上下文是否失效
- ✅ 显示友好的中英文错误提示
- ✅ 自动停止所有后台处理，避免继续报错
- ✅ 用户只需刷新页面即可恢复

## 正常使用流程

### 1. 安装插件

1. 打开 Chrome 浏览器，访问 `chrome://extensions`
2. 开启右上角的"开发者模式"
3. 点击"加载已解压的扩展程序"
4. 选择本项目文件夹

### 2. 在 YAPI 中使用

1. 打开 YAPI 测试页面
2. 配置接口测试参数
3. 点击发送请求
4. 插件会自动处理跨域请求

### 3. 调试建议

如果遇到问题：

1. **打开浏览器控制台**（F12）
   - 查看 Console 标签页的错误信息
   - 红色错误通常会有详细的提示

2. **检查扩展是否正常加载**
   - 访问 `chrome://extensions`
   - 确认插件已启用
   - 确认没有错误提示

3. **遇到"Extension context invalidated"错误**
   - **直接刷新页面（F5）即可**
   - 这不是 bug，是正常行为

4. **遇到其他错误**
   - 检查网络连接
   - 检查 YAPI 配置是否正确
   - 查看控制台的详细错误信息

## 开发者注意事项

### 修改插件代码后

1. 修改代码后，需要在 `chrome://extensions` 重新加载插件
2. **重新加载插件后，必须刷新所有使用插件的页面**
3. 这样才能使用最新版本的代码

### 常见开发流程

```
1. 修改代码
2. 保存文件
3. 去 chrome://extensions 重新加载插件
4. 回到 YAPI 页面，按 F5 刷新页面
5. 重新测试功能
```

## 功能说明

### 跨域请求处理

- ✅ 自动处理跨域请求
- ✅ 支持自定义请求头
- ✅ 支持文件上传
- ✅ 支持代理设置

### 请求头处理

- ✅ 支持大部分自定义请求头
- ⚠️ 某些浏览器保留头部（如 User-Agent, Connection）不能修改
- ⚠️ 如果看到 "Cannot set header" 警告，这是正常的

### 代理功能

插件支持通过 `GTest-Proxy` 头部设置代理：

```javascript
headers: {
  'GTest-Proxy': '127.0.0.1:8888'
}
```

## 错误提示说明

### 1. Extension context invalidated
```
扩展已重新加载或更新，请刷新页面。
```
**解决方法：** 刷新页面（F5）

### 2. Failed to establish connection
```
无法建立与扩展的连接。
```
**可能原因：**
- 扩展未正确加载
- 扩展被禁用

**解决方法：**
1. 检查 `chrome://extensions` 确认插件已启用
2. 刷新页面

### 3. Cannot set header
```
Cannot set header: User-Agent
```
**说明：** 这是浏览器的内置限制，某些头部无法修改，这通常不影响功能。

## 技术支持

### 常见问题

**Q: 为什么每次修改代码都要刷新页面？**

A: 因为扩展重新加载后，页面中的旧代码已经失效。刷新页面会重新注入新的代码。

**Q: 可以避免刷新页面吗？**

A: 不行。这是 Chrome 扩展的机制限制。所有扩展都是这样的。

**Q: 请求失败怎么办？**

A: 
1. 检查控制台的具体错误信息
2. 确认网络连接正常
3. 确认接口地址正确
4. 检查请求参数格式

**Q: 如何查看请求详情？**

A: 
1. 打开浏览器控制台（F12）
2. 切换到 Network 标签页
3. 重新发送请求
4. 查看请求和响应的详细信息

## 版本信息

- Manifest 版本：V3
- 支持浏览器：Chrome 88+, Edge 88+
- 最后更新：2025-10

## 更新日志

### V3.3 (Manifest V3 升级)

- ✅ 升级到 Manifest V3
- ✅ 移除了 webRequestBlocking 权限
- ✅ 添加了扩展上下文检测
- ✅ 优化了错误处理和提示
- ✅ 添加了自动重连机制
- ✅ 改进了 Service Worker 兼容性
